<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}} - Pilate Studio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .admin-container {
            padding: 20px;
            margin-top: 70px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .stats-card p {
            margin: 5px 0 0 0;
            font-size: 1rem;
            opacity: 0.9;
        }
        .table-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .table-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .table-section h2 i {
            margin-right: 10px;
        }
        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: white;
            background-color: #667eea;
            border-color: #667eea;
        }
        .table {
            font-size: 0.9rem;
        }
        .table thead th {
            background-color: #f8f9fa;
            color: #667eea;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
        }
        .badge {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        .status-active { background-color: #28a745; }
        .status-inactive { background-color: #dc3545; }
        .status-confirmed { background-color: #17a2b8; }
        .status-completed { background-color: #28a745; }
        .status-cancelled { background-color: #dc3545; }
        .status-paid { background-color: #28a745; }
        .status-pending { background-color: #ffc107; }
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
        /* Highlight selected users in multiselect */
        select[multiple] option.user-assigned {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
        }
        select[multiple] option:checked {
            background-color: #0d6efd;
            color: white;
        }
        
        /* Weekly Calendar Styles */
        .schedule-calendar-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 900px;
        }
        
        .schedule-calendar-table th,
        .schedule-calendar-table td {
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: top;
        }
        
        .schedule-calendar-table thead th {
            background-color: #f8f9fa;
            padding: 12px 6px;
            font-weight: 700;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .schedule-calendar-table thead th.time-col {
            width: 70px;
            min-width: 70px;
        }
        
        .schedule-calendar-table thead th .day-name {
            font-size: 0.95rem;
            display: block;
        }
        
        .schedule-calendar-table thead th .day-date {
            font-size: 0.8rem;
            color: #888;
            font-weight: 500;
            display: block;
        }
        
        .schedule-calendar-table thead th.today-col {
            background-color: #667eea;
            color: #fff;
        }
        
        .schedule-calendar-table thead th.today-col .day-date {
            color: rgba(255,255,255,0.8);
        }
        
        .schedule-calendar-table tbody td.time-col {
            background-color: #f8f9fa;
            font-weight: 600;
            font-size: 0.85rem;
            color: #555;
            vertical-align: middle;
            text-align: right;
            padding: 8px 10px;
            width: 70px;
            min-width: 70px;
        }
        
        .schedule-calendar-table tbody td.day-col {
            padding: 4px;
            height: 120px;
            vertical-align: top;
            position: relative;
            background: #ff000015;
        }
        
        .schedule-calendar-table tbody td.day-col.today-col {
            background-color: rgba(102, 126, 234, 0.04);
        }
        
        .schedule-calendar-table tbody td.day-col:hover {
            cursor: pointer;
        }
        
        .schedule-calendar-table tbody td.day-col.past-col {
            cursor: default;
            opacity: 0.5;
        }
        
        .schedule-calendar-table tbody td.day-col.past-col.has-schedule {
            opacity: 1;
        }
        
        .schedule-calendar-table tbody td.day-col.past-col:hover {
            background-color: #eee;
            cursor: default;
        }
        
        .schedule-calendar-table tbody td.day-col.past-col::after {
            display: none;
        }
        
        .schedule-calendar-table tbody td.day-col::after {
            content: '+';
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 1.2rem;
            color: rgba(102, 126, 234, 0.2);
            font-weight: bold;
            pointer-events: none;
            transition: color 0.2s;
        }
        
        .schedule-calendar-table tbody td.day-col:hover::after {
            color: rgba(102, 126, 234, 0.6);
        }
        
        .schedule-calendar-table tbody tr.empty-row td.day-col {
            background-color: #ff000015;
        }
        
        .schedule-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .schedule-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: rgba(255,255,255,0.4);
            border-radius: 6px 0 0 6px;
        }
        
        .schedule-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .schedule-item-title {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 3px;
            letter-spacing: 0.3px;
        }
        
        .schedule-item-trainer {
            font-size: 0.72rem;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .schedule-item-meta {
            font-size: 0.68rem;
            opacity: 0.85;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .schedule-item-meta i {
            font-size: 0.6rem;
        }
        
        .schedule-item.bg-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .schedule-item.bg-completed {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: #1a3a2a;
        }
        
        .schedule-item.bg-completed::before {
            background: rgba(0,0,0,0.15);
        }
        
        .schedule-item.bg-cancelled {
            background: linear-gradient(135deg, #f5576c 0%, #ff6b6b 100%);
        }
        
        .schedule-item.bg-cancelled .schedule-item-title {
            text-decoration: line-through;
        }
        
        .schedule-item-gender {
            display: inline-block;
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 3px;
            background: rgba(255,255,255,0.25);
            margin-left: 4px;
            vertical-align: middle;
        }
        
        .schedule-item-delete {
            position: absolute;
            top: 4px;
            right: 5px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px;
            line-height: 1;
            border-radius: 3px;
            display: none;
        }
        
        .schedule-item:hover .schedule-item-delete {
            display: block;
        }
        
        .schedule-item-delete:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        
        /* Calendar container */
        .calendar-scroll-container {
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        @media (max-width: 1200px) {
            .schedule-item {
                padding: 5px 7px;
            }
            .schedule-item-title {
                font-size: 0.72rem;
            }
            .schedule-item-trainer,
            .schedule-item-meta {
                font-size: 0.65rem;
            }
            .schedule-calendar-table tbody td.day-col {
                height: 100px;
            }
        }
    </style>
</head>
<body>
    {{> header}}
    <div class="admin-container">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
                <div>
                    <a href="/admin/homepage-editor" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Edit Homepage
                    </a>
                    <a href="/" class="btn btn-outline-secondary" target="_blank">
                        <i class="fas fa-home"></i> View Site
                    </a>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Memuat data...</p>
            </div>

            <!-- Statistics Cards -->
            <div id="statsSection" style="display: none;">
                <div class="mb-3">
                    <button class="btn btn-sm btn-primary" onclick="loadAdminData()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <small class="text-muted ms-2">(Auto-refreshes every 10 seconds)</small>
                </div>
                <div class="row mb-4">
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="stats-card">
                            <h3 id="totalUsers">0</h3>
                            <p><i class="fas fa-users"></i> Total Users</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <h3 id="totalBookings">0</h3>
                            <p><i class="fas fa-calendar-check"></i> Bookings</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <h3 id="totalClasses">0</h3>
                            <p><i class="fas fa-dumbbell"></i> Classes</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <h3 id="totalTransactions">0</h3>
                            <p><i class="fas fa-money-bill"></i> Transactions</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <h3 id="totalSchedules">0</h3>
                            <p><i class="fas fa-calendar-alt"></i> Schedules</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <h3 id="totalTrainers">0</h3>
                            <p><i class="fas fa-user-tie"></i> Trainers</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div id="tabsSection" style="display: none;">
                <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="schedules-tab" data-bs-toggle="tab" data-bs-target="#schedules" type="button" role="tab">
                            <i class="fas fa-calendar-alt"></i> Schedules
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                            <i class="fas fa-users"></i> Users
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">
                            <i class="fas fa-calendar-check"></i> Bookings
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes" type="button" role="tab">
                            <i class="fas fa-dumbbell"></i> Classes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
                            <i class="fas fa-money-bill"></i> Transactions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trainers-tab" data-bs-toggle="tab" data-bs-target="#trainers" type="button" role="tab">
                            <i class="fas fa-user-tie"></i> Trainers
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="adminTabsContent">
                    <!-- Users Table -->
                    <div class="tab-pane fade" id="users" role="tabpanel">
                        <div class="table-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="mb-0"><i class="fas fa-users"></i> Users</h2>
                                <div>
                                    <div class="btn-group me-2" role="group">
                                        <button type="button" class="btn btn-outline-danger" id="filterExpired" onclick="filterUsers('expired')">
                                            <i class="fas fa-exclamation-circle"></i> Expired
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="filterActive" onclick="filterUsers('active')">
                                            <i class="fas fa-check-circle"></i> Active
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary active" id="filterAll" onclick="filterUsers('all')">
                                            <i class="fas fa-list"></i> All
                                        </button>
                                    </div>
                                    <button class="btn btn-primary" onclick="showAddModal('user')"><i class="fas fa-plus"></i> Add New User</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table id="usersTable" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Membership</th>
                                            <th>Credits</th>
                                            <th>Period</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Bookings Table -->
                    <div class="tab-pane fade" id="bookings" role="tabpanel">
                        <div class="table-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="mb-0"><i class="fas fa-calendar-check"></i> Bookings</h2>
                                <button class="btn btn-primary" onclick="showAddModal('booking')"><i class="fas fa-plus"></i> Add New Booking</button>
                            </div>
                            <div class="table-responsive">
                                <table id="bookingsTable" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Schedule ID</th>
                                            <th>User ID</th>
                                            <th>Booking Time</th>
                                            <th>Status</th>
                                            <th>Attended</th>
                                            <th>Payment Status</th>
                                            <th>Credits Used</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Classes Table -->
                    <div class="tab-pane fade" id="classes" role="tabpanel">
                        <div class="table-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="mb-0"><i class="fas fa-dumbbell"></i> Classes</h2>
                                <button class="btn btn-primary" onclick="showAddModal('class')"><i class="fas fa-plus"></i> Add New Class</button>
                            </div>
                            <div class="table-responsive">
                                <table id="classesTable" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Duration</th>
                                            <th>Capacity</th>
                                            <th>Price</th>
                                            <th>Credits Required</th>
                                            <th>Status</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="classesTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="tab-pane fade" id="transactions" role="tabpanel">
                        <div class="table-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="mb-0"><i class="fas fa-money-bill"></i> Transactions</h2>
                                <button class="btn btn-primary" onclick="showAddModal('transaction')"><i class="fas fa-plus"></i> Add New Transaction</button>
                            </div>
                            <div class="table-responsive">
                                <table id="transactionsTable" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>User ID</th>
                                            <th>Transaction Time</th>
                                            <th>Amount</th>
                                            <th>Credits Purchased</th>
                                            <th>Payment Method</th>
                                            <th>Status</th>
                                            <th>Invoice</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Schedules Calendar -->
                    <div class="tab-pane fade show active" id="schedules" role="tabpanel">
                        <div class="table-section">
                            <h2 class="mb-4"><i class="fas fa-calendar-alt"></i> Jadwal Kelas Mingguan</h2>
                            
                            <!-- Week Navigation -->
                            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-sm btn-outline-primary" onclick="previousWeek()">
                                        <i class="fas fa-chevron-left"></i> Minggu Sebelumnya
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="goToToday()">
                                        <i class="fas fa-calendar-day"></i> Hari Ini
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="nextWeek()">
                                        Minggu Depan <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <input type="date" id="weekDatePicker" class="form-control form-control-sm" style="width: 150px;" onchange="goToDate()">
                                </div>
                                <div>
                                    <span id="weekDisplay" style="font-size: 1rem; font-weight: 600; color: #667eea;"></span>
                                </div>
                                <button class="btn btn-sm btn-success" onclick="showAddModal('schedule')">
                                    <i class="fas fa-plus"></i> Tambah Jadwal
                                </button>
                            </div>

                            <!-- Weekly Calendar -->
                            <div class="calendar-scroll-container">
                                <table class="schedule-calendar-table" id="scheduleCalendarTable">
                                    <thead id="calendarHead"></thead>
                                    <tbody id="calendarBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Trainers Table -->
                    <div class="tab-pane fade" id="trainers" role="tabpanel">
                        <div class="table-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="mb-0"><i class="fas fa-user-tie"></i> Trainers</h2>
                                <button class="btn btn-primary" onclick="showAddModal('trainer')"><i class="fas fa-plus"></i> Add New Trainer</button>
                            </div>
                            <div class="table-responsive">
                                <table id="trainersTable" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Specialization</th>
                                            <th>Status</th>
                                            <th>Joined Date</th>
                                            <th>Bio</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trainersTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{> footer}}

    <!-- CRUD Modal -->
    <div class="modal fade" id="crudModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="crudModalTitle">Add New</h5>
                    <button type="button" class="btn-close" id="modalCloseBtn" onclick="closeModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="crudForm">
                        <input type="hidden" id="recordId">
                        <input type="hidden" id="recordType">
                        <div id="formFields"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="modalCancelBtn" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modalSaveBtn" onclick="saveRecord()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load jQuery first -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    
    <!-- Load Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <script>
        // Initialize dashboard when DOM is ready
        $(document).ready(function() {
            console.log('=== Initializing Dashboard ===');
            console.log('jQuery:', typeof jQuery !== 'undefined' ? '✓' : '✗');
            loadAdminData();
            
            // Auto-refresh data every 10 seconds
            setInterval(loadAdminData, 10000);
        });
        
        function loadAdminData() {
            console.log('=== Fetching Admin Data ===');
            $.ajax({
                url: '/api/admin/data',
                method: 'GET',
                success: function(response) {
                    console.log('Data fetched successfully', response);
                    if (response.success) {
                        const data = response.data;
                        
                        // Store data globally for form dropdowns
                        window.adminData = data;
                        
                        // Clear all table bodies first
                        $('#usersTableBody').empty();
                        $('#bookingsTableBody').empty();
                        $('#classesTableBody').empty();
                        $('#transactionsTableBody').empty();
                        $('#trainersTableBody').empty();
                        
                        // Update statistics
                        $('#totalUsers').text(data.stats.totalUsers);
                        $('#totalBookings').text(data.stats.totalBookings);
                        $('#totalClasses').text(data.stats.totalClasses);
                        $('#totalTransactions').text(data.stats.totalTransactions);
                        $('#totalSchedules').text(data.stats.totalSchedules);
                        $('#totalTrainers').text(data.stats.totalTrainers);
                        
                        // Sort users by expired_date (furthest from today first)
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        data.users.sort((a, b) => {
                            // Handle missing expired_date (put at bottom)
                            if (!a.expired_date && !b.expired_date) return 0;
                            if (!a.expired_date) return 1;
                            if (!b.expired_date) return -1;
                            
                            const dateA = new Date(a.expired_date);
                            const dateB = new Date(b.expired_date);
                            dateA.setHours(0, 0, 0, 0);
                            dateB.setHours(0, 0, 0, 0);
                            
                            const isAExpired = dateA < today;
                            const isBExpired = dateB < today;
                            
                            // If both expired or both not expired
                            if (isAExpired === isBExpired) {
                                if (isAExpired) {
                                    // Both expired: yang paling baru expired di atas (yang lama expired di bawah)
                                    return dateB - dateA; // descending (newer expired date first)
                                } else {
                                    // Both not expired: yang paling dekat expire di atas
                                    return dateA - dateB; // ascending (closer expiry date first)
                                }
                            }
                            
                            // Expired comes before not expired (prioritas yang sudah expired)
                            return isAExpired ? -1 : 1;
                        });
                        
                        // Populate Users table
                        data.users.forEach(user => {
                            const statusClass = user.membership_status === 'Active' ? 'status-active' : 'status-inactive';
                            
                            // Check if expired_date is past today
                            let expiredDateHTML = user.expired_date || '-';
                            let isExpired = false;
                            if (user.expired_date) {
                                const expiredDate = new Date(user.expired_date);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                expiredDate.setHours(0, 0, 0, 0);
                                
                                if (expiredDate < today) {
                                    isExpired = true;
                                    expiredDateHTML = `<span style="color: #d32f2f; font-weight: bold;">${user.expired_date}</span>`;
                                } else {
                                    expiredDateHTML = user.expired_date;
                                }
                            }
                            
                            $('#usersTableBody').append(`
                                <tr data-expired="${isExpired}">
                                    <td>${user.id}</td>
                                    <td>
                                        <strong>${user.name}</strong><br>
                                        <small class="text-muted">${user.email}</small><br>
                                        <small><i class="fas fa-${user.gender === 'M' ? 'mars' : 'venus'}"></i> ${user.gender === 'M' ? 'Male' : user.gender === 'F' ? 'Female' : user.gender}</small>
                                    </td>
                                    <td>${user.phone}</td>
                                    <td>${user.membership_type}</td>
                                    <td>${user.total_credits}</td>
                                    <td>
                                        <small class="text-muted">Reg: ${user.registered_date}</small><br>
                                        <small>Exp: ${expiredDateHTML}</small>
                                    </td>
                                    <td><span class="badge ${statusClass}">${user.membership_status}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick='editRecord("user", ${JSON.stringify(user)})'><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('user', '${user.id}', '${user.name}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `);
                        });
                        
                        // Populate Bookings table
                        data.bookings.forEach(booking => {
                            let statusClass = 'status-confirmed';
                            if (booking.status === 'Completed') statusClass = 'status-completed';
                            if (booking.status === 'Cancelled') statusClass = 'status-cancelled';
                            
                            const paymentClass = booking.payment_status === 'Paid' ? 'status-paid' : 'status-pending';
                            
                            $('#bookingsTableBody').append(`
                                <tr>
                                    <td>${booking.id}</td>
                                    <td>${booking.schedule_id}</td>
                                    <td>${booking.user_id}</td>
                                    <td>${booking.booking_time}</td>
                                    <td><span class="badge ${statusClass}">${booking.status}</span></td>
                                    <td>${booking.attended === '1' ? 'Yes' : 'No'}</td>
                                    <td><span class="badge ${paymentClass}">${booking.payment_status}</span></td>
                                    <td>${booking.credits_used}</td>
                                    <td>${booking.notes}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick='editRecord("booking", ${JSON.stringify(booking)})'><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('booking', '${booking.id}', 'Booking #${booking.id}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `);
                        });
                        
                        // Populate Classes table
                        data.classes.forEach(cls => {
                            const statusClass = cls.status === 'Active' ? 'status-active' : 'status-inactive';
                            $('#classesTableBody').append(`
                                <tr>
                                    <td>${cls.id}</td>
                                    <td>${cls.name}</td>
                                    <td>${cls.duration} min</td>
                                    <td>${cls.capacity}</td>
                                    <td>Rp ${parseInt(cls.price).toLocaleString('id-ID')}</td>
                                    <td>${cls.credits_required}</td>
                                    <td><span class="badge ${statusClass}">${cls.status}</span></td>
                                    <td>${cls.description}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick='editRecord("class", ${JSON.stringify(cls)})'><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('class', '${cls.id}', '${cls.name}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `);
                        });
                        
                        // Populate Transactions table
                        data.transactions.forEach(transaction => {
                            const statusClass = transaction.payment_status === 'Paid' ? 'status-paid' : 'status-pending';
                            $('#transactionsTableBody').append(`
                                <tr>
                                    <td>${transaction.id}</td>
                                    <td>${transaction.user_id}</td>
                                    <td>${transaction.transaction_time}</td>
                                    <td>Rp ${parseInt(transaction.amount).toLocaleString('id-ID')}</td>
                                    <td>${transaction.credits_purchased}</td>
                                    <td>${transaction.payment_method}</td>
                                    <td><span class="badge ${statusClass}">${transaction.payment_status}</span></td>
                                    <td>${transaction.invoice_number}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick='editRecord("transaction", ${JSON.stringify(transaction)})'><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('transaction', '${transaction.id}', '${transaction.invoice_number}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `);
                        });
                        
                        // Populate Schedules calendar
                        window.calendarSchedules = data.schedules;
                        initCalendarView();
                        
                        // Populate Trainers table
                        data.trainers.forEach(trainer => {
                            const statusClass = trainer.status === 'Active' ? 'status-active' : 'status-inactive';
                            $('#trainersTableBody').append(`
                                <tr>
                                    <td>${trainer.id}</td>
                                    <td>${trainer.name}</td>
                                    <td>${trainer.email}</td>
                                    <td>${trainer.phone}</td>
                                    <td>${trainer.specialization}</td>
                                    <td><span class="badge ${statusClass}">${trainer.status}</span></td>
                                    <td>${trainer.joined_date}</td>
                                    <td>${trainer.bio}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick='editRecord("trainer", ${JSON.stringify(trainer)})'><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('trainer', '${trainer.id}', '${trainer.name}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `);
                        });
                        
                        console.log('✓ Tables loaded successfully (using simple tables without DataTables)');
                        
                        // Hide loading spinner and show content
                        $('#loadingSpinner').hide();
                        $('#statsSection').show();
                        $('#tabsSection').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr, status, error);
                    $('#loadingSpinner').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Error loading data: ${error}
                            <br><small>Status: ${xhr.status} ${xhr.statusText}</small>
                        </div>
                    `);
                }
            });
        }
        
        // Form field definitions for each entity type
        const formFields = {
            user: [
                { name: 'name', label: 'Name', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'phone', label: 'Phone', type: 'text', required: true },
                { name: 'password', label: 'Password', type: 'password', required: true },
                { name: 'membership_type', label: 'Membership Type', type: 'select', options: ['Basic', 'Premium', 'VIP'], required: true },
                { name: 'membership_status', label: 'Status', type: 'select', options: ['Active', 'Inactive'], required: true },
                { name: 'expired_date', label: 'Expired Date', type: 'date', required: true },
                { name: 'total_credits', label: 'Total Credits', type: 'number', required: true },
                { name: 'gender', label: 'Gender', type: 'select', options: ['M', 'F'], required: true },
                { name: 'role', label: 'Role', type: 'select', options: ['user', 'admin'], required: true }
            ],
            booking: [
                { name: 'schedule_id', label: 'Schedule', type: 'select-dynamic', source: 'schedules', required: true },
                { name: 'user_id', label: 'User', type: 'select-dynamic', source: 'users', required: true },
                { name: 'status', label: 'Status', type: 'select', options: ['Confirmed', 'Completed', 'Cancelled'], required: true },
                { name: 'attended', label: 'Attended', type: 'select', options: ['0', '1'], required: true },
                { name: 'payment_status', label: 'Payment Status', type: 'select', options: ['Pending', 'Paid'], required: true },
                { name: 'credits_used', label: 'Credits Used', type: 'number', required: true },
                { name: 'notes', label: 'Notes', type: 'textarea', required: false }
            ],
            class: [
                { name: 'name', label: 'Class Name', type: 'text', required: true },
                { name: 'duration', label: 'Duration (minutes)', type: 'number', required: true },
                { name: 'capacity', label: 'Capacity', type: 'number', required: true },
                { name: 'price', label: 'Price', type: 'number', required: true },
                { name: 'credits_required', label: 'Credits Required', type: 'number', required: true },
                { name: 'status', label: 'Status', type: 'select', options: ['Active', 'Inactive'], required: true },
                { name: 'description', label: 'Description', type: 'textarea', required: false }
            ],
            transaction: [
                { name: 'user_id', label: 'User ID', type: 'number', required: true },
                { name: 'amount', label: 'Amount', type: 'number', required: true },
                { name: 'credits_purchased', label: 'Credits Purchased', type: 'number', required: true },
                { name: 'payment_method', label: 'Payment Method', type: 'select', options: ['Bank Transfer', 'Credit Card', 'E-Wallet', 'Cash'], required: true },
                { name: 'payment_status', label: 'Payment Status', type: 'select', options: ['Pending', 'Paid'], required: true },
                { name: 'invoice_number', label: 'Invoice Number', type: 'text', required: true }
            ],
            schedule: [
                { name: 'schedule_time', label: 'Schedule Time', type: 'datetime-local', required: true },
                { name: 'trainer_id', label: 'Trainer', type: 'select-dynamic', source: 'trainers', required: true },
                { name: 'class_id', label: 'Class', type: 'select-dynamic', source: 'classes', required: true },
                { name: 'assigned_users', label: 'Assign Users', type: 'multiselect-dynamic', source: 'users', required: false },
                { name: 'gender_restriction', label: 'Gender Restriction', type: 'select', options: ['', 'M', 'F'], required: false },
                { name: 'status', label: 'Status', type: 'select', options: ['Active', 'Completed', 'Cancelled'], required: true },
                { name: 'notes', label: 'Notes', type: 'textarea', required: false }
            ],
            trainer: [
                { name: 'name', label: 'Name', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'phone', label: 'Phone', type: 'text', required: true },
                { name: 'specialization', label: 'Specialization', type: 'text', required: true },
                { name: 'status', label: 'Status', type: 'select', options: ['Active', 'Inactive'], required: true },
                { name: 'bio', label: 'Bio', type: 'textarea', required: false }
            ]
        };
        
        // Show Add Modal
        function showAddModal(type) {
            $('#recordId').val('');
            $('#recordType').val(type);
            $('#crudModalTitle').text('Add New ' + type.charAt(0).toUpperCase() + type.slice(1));
            
            generateFormFields(type);
            
            // Use jQuery Bootstrap modal API
            $('#crudModal').modal('show');
        }
        
        // Close Modal
        function closeModal() {
            console.log('Closing modal...');
            // Use jQuery Bootstrap modal API
            $('#crudModal').modal('hide');
            
            // Cleanup backdrop and body class
            setTimeout(() => {
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open').css({
                    overflow: '',
                    paddingRight: ''
                });
            }, 300);
        }
        
        // Show Edit Modal
        function editRecord(type, record) {
            $('#recordId').val(record.id);
            $('#recordType').val(type);
            $('#crudModalTitle').text('Edit ' + type.charAt(0).toUpperCase() + type.slice(1));
            
            console.log('Editing record:', type, record);
            
            generateFormFields(type, record);
            
            // Use jQuery Bootstrap modal API
            $('#crudModal').modal('show');
        }
        
        // Edit schedule by index (special handler)
        function editScheduleById(index) {
            if (window.adminData && window.adminData.schedules && window.adminData.schedules[index]) {
                const schedule = window.adminData.schedules[index];
                console.log('Editing schedule:', schedule);
                editRecord('schedule', schedule);
            } else {
                alert('Schedule data not found');
            }
        }
        
        // Generate Form Fields
        function generateFormFields(type, data = {}) {
            console.log(`[generateFormFields] Type: ${type}, Data:`, data);
            
            const fields = formFields[type];
            let html = '';
            
            fields.forEach(field => {
                const value = data[field.name] || '';
                const required = field.required ? 'required' : '';
                
                console.log(`[Field] ${field.name} = "${value}" (type: ${field.type})`);
                
                html += `<div class="mb-3">`;
                html += `<label for="${field.name}" class="form-label">${field.label}</label>`;
                
                if (field.type === 'select') {
                    html += `<select class="form-control" id="${field.name}" name="${field.name}" ${required}>`;
                    html += `<option value="">Select ${field.label}</option>`;
                    field.options.forEach(opt => {
                        const selected = value == opt ? 'selected' : '';
                        html += `<option value="${opt}" ${selected}>${opt}</option>`;
                    });
                    html += `</select>`;
                } else if (field.type === 'select-dynamic') {
                    // Dynamic dropdown from data source
                    html += `<select class="form-control" id="${field.name}" name="${field.name}" ${required}>`;
                    html += `<option value="">Select ${field.label}</option>`;
                    
                    if (window.adminData && window.adminData[field.source]) {
                        window.adminData[field.source].forEach(item => {
                            const selected = value == item.id ? 'selected' : '';
                            
                            // Special formatting for schedules - show schedule time
                            let displayName;
                            if (field.source === 'schedules') {
                                displayName = item.schedule_time || item.stime || item.id;
                            } else {
                                displayName = item.name || item.title || item.id;
                            }
                            
                            html += `<option value="${item.id}" ${selected}>${item.id} - ${displayName}</option>`;
                        });
                    }
                    html += `</select>`;
                } else if (field.type === 'multiselect-dynamic') {
                    // Multi-select dropdown from data source
                    html += `<select class="form-control" id="${field.name}" name="${field.name}" multiple size="10" ${required} style="background-color: white;">`;
                    
                    if (window.adminData && window.adminData[field.source]) {
                        // Get assigned user IDs - could be from assigned_users, members, or comma-separated string
                        let selectedValues = [];
                        if (data.assigned_users) {
                            selectedValues = Array.isArray(data.assigned_users) ? data.assigned_users : data.assigned_users.split(',').map(v => v.trim());
                        } else if (data.members && typeof data.members === 'string' && data.members.includes(',')) {
                            selectedValues = data.members.split(',').map(v => v.trim());
                        } else if (value) {
                            selectedValues = Array.isArray(value) ? value : value.split(',').map(v => v.trim());
                        }
                        
                        console.log('Selected user IDs for multiselect:', selectedValues);
                        
                        window.adminData[field.source].forEach(item => {
                            const isSelected = selectedValues.includes(String(item.id));
                            const selectedAttr = isSelected ? 'selected' : '';
                            const classAttr = isSelected ? 'class="user-assigned"' : '';
                            const displayName = item.name || item.title || item.id;
                            html += `<option value="${item.id}" ${selectedAttr} ${classAttr}>${item.id} - ${displayName}</option>`;
                        });
                    }
                    html += `</select>`;
                    html += `<small class="form-text text-muted">Hold Ctrl/Cmd to select multiple users. <strong style="color: #0d6efd;">■ Blue = Currently assigned members</strong></small>`;
                } else if (field.type === 'textarea') {
                    html += `<textarea class="form-control" id="${field.name}" name="${field.name}" rows="3" ${required}>${value}</textarea>`;
                } else if (field.type === 'datetime-local') {
                    // Convert datetime format from "YYYY-MM-DD HH:MM:SS" to "YYYY-MM-DDTHH:MM"
                    let inputValue = value;
                    console.log(`[DateTime Debug] Field: ${field.name}, Original Value: "${value}", Type: ${typeof value}`);
                    
                    if (value && value.includes(' ')) {
                        // Format: "2025-12-20 16:00:00" or "2025-12-20 8:00:00" -> "2025-12-20T16:00" or "2025-12-20T08:00"
                        const [datePart, timePart] = value.split(' ');
                        
                        // Parse time parts and pad with zeros if needed
                        const timeComponents = timePart.split(':');
                        const hours = timeComponents[0].padStart(2, '0');
                        const minutes = timeComponents[1].padStart(2, '0');
                        
                        inputValue = `${datePart}T${hours}:${minutes}`;
                        console.log(`[DateTime Debug] Converted Value: "${inputValue}"`);
                    } else {
                        console.log(`[DateTime Debug] No conversion needed or empty value`);
                    }
                    
                    html += `<input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" value="${inputValue}" ${required}>`;
                } else {
                    // For edit mode on password field, don't show existing value
                    const inputValue = field.name === 'password' && data.id ? '' : value;
                    const placeholder = field.name === 'password' && data.id ? 'Leave empty to keep current password' : '';
                    const readonlyAttr = field.readonly ? 'readonly style="background-color: #e9ecef;"' : '';
                    html += `<input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" value="${inputValue}" placeholder="${placeholder}" ${required} ${readonlyAttr}>`;
                }
                
                html += `</div>`;
            });
            
            $('#formFields').html(html);
            
            // Add event listener for class_id change to auto-fill members
            $('#class_id').on('change', function() {
                const classId = $(this).val();
                if (classId && window.adminData && window.adminData.classes) {
                    const selectedClass = window.adminData.classes.find(c => c.id == classId);
                    if (selectedClass && selectedClass.capacity) {
                        $('#members').val(selectedClass.capacity);
                        console.log('Auto-filled members with capacity:', selectedClass.capacity);
                    }
                }
            });
            
            // Add event listener for assigned_users to validate capacity
            if (type === 'schedule') {
                $('#assigned_users').on('change', function() {
                    const selectedUsers = $(this).val() || [];
                    const classId = $('#class_id').val();
                    
                    if (classId && window.adminData && window.adminData.classes) {
                        const selectedClass = window.adminData.classes.find(c => c.id == classId);
                        if (selectedClass && selectedClass.capacity) {
                            const capacity = parseInt(selectedClass.capacity);
                            const selectedCount = selectedUsers.length;
                            
                            if (selectedCount > capacity) {
                                alert(`⚠️ WARNING!\n\nYou have selected ${selectedCount} users, but the class capacity is only ${capacity}.\n\nPlease remove ${selectedCount - capacity} user(s) to match the capacity limit.`);
                                
                                // Show visual warning
                                $(this).css('border', '3px solid red');
                                $(this).next('small').html(`<strong style="color: red;">⚠️ CAPACITY EXCEEDED! Selected: ${selectedCount}/${capacity} - Remove ${selectedCount - capacity} user(s)</strong>`);
                            } else if (selectedCount === capacity) {
                                // At capacity - show yellow warning
                                $(this).css('border', '2px solid #ffc107');
                                $(this).next('small').html(`<strong style="color: #ffc107;">⚠️ FULL! Selected: ${selectedCount}/${capacity} users</strong>`);
                            } else {
                                // Under capacity - show normal
                                $(this).css('border', '1px solid #ced4da');
                                $(this).next('small').html(`Hold Ctrl/Cmd to select multiple users. <strong style="color: #0d6efd;">■ Blue = Currently assigned members</strong> | <strong style="color: #28a745;">Selected: ${selectedCount}/${capacity}</strong>`);
                            }
                        }
                    }
                });
                
                // Trigger initial check if editing
                if (data.id) {
                    setTimeout(() => $('#assigned_users').trigger('change'), 100);
                }
            }
        }
        
        // Save Record (Create or Update)
        function saveRecord() {
            const type = $('#recordType').val();
            const id = $('#recordId').val();
            const isEdit = id !== '';
            
            // Special validation for schedule
            if (type === 'schedule') {
                const selectedUsers = $('#assigned_users').val() || [];
                const classId = $('#class_id').val();
                
                if (classId && window.adminData && window.adminData.classes) {
                    const selectedClass = window.adminData.classes.find(c => c.id == classId);
                    if (selectedClass && selectedClass.capacity) {
                        const capacity = parseInt(selectedClass.capacity);
                        const selectedCount = selectedUsers.length;
                        
                        if (selectedCount > capacity) {
                            alert(`❌ CANNOT SAVE!\n\nYou have assigned ${selectedCount} users, but the class capacity is only ${capacity}.\n\nPlease remove ${selectedCount - capacity} user(s) before saving.`);
                            $('#assigned_users').css('border', '3px solid red').focus();
                            return;
                        }
                    }
                }
            }
            
            // Collect form data
            const formData = {};
            $('#crudForm').find('input, select, textarea').each(function() {
                const name = $(this).attr('name');
                if (name && name !== '') {
                    // Handle multi-select
                    if ($(this).attr('multiple')) {
                        const selectedValues = $(this).val();
                        formData[name] = selectedValues ? selectedValues.join(',') : '';
                    } else {
                        formData[name] = $(this).val();
                    }
                }
            });
            
            // Validate required fields
            let isValid = true;
            $('#crudForm').find('[required]').each(function() {
                if (!$(this).val() || ($(this).attr('multiple') && $(this).val().length === 0)) {
                    $(this).addClass('is-invalid');
                    isValid = false;
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            
            if (!isValid) {
                alert('Please fill all required fields');
                return;
            }
            
            // AJAX call to save
            const url = isEdit ? `/api/admin/${type}/${id}` : `/api/admin/${type}`;
            const method = isEdit ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                method: method,
                data: JSON.stringify(formData),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        // Show success message briefly
                        const successMessage = isEdit ? 'Record updated successfully' : 'Record created successfully';
                        console.log('✓ ' + successMessage);
                        
                        // Close the modal using our closeModal function
                        closeModal();
                        
                        // Show success toast/alert
                        const alertDiv = $(`
                            <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                                <i class="fas fa-check-circle"></i> ${successMessage}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `);
                        $('body').append(alertDiv);
                        
                        // Auto-dismiss after 3 seconds
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 3000);
                        
                        // Reload data to refresh tables
                        setTimeout(() => {
                            loadAdminData();
                        }, 500);
                    } else {
                        alert('❌ Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Save error:', xhr, status, error);
                    const errorMessage = xhr.responseJSON?.message || error;
                    alert('❌ Error saving record: ' + errorMessage);
                }
            });
        }
        
        // Filter Users by Expiry Status
        function filterUsers(filter) {
            // Update button states
            $('#filterExpired, #filterActive, #filterAll').removeClass('active');
            if (filter === 'expired') {
                $('#filterExpired').addClass('active');
            } else if (filter === 'active') {
                $('#filterActive').addClass('active');
            } else {
                $('#filterAll').addClass('active');
            }
            
            // Filter table rows
            $('#usersTableBody tr').each(function() {
                const isExpired = $(this).attr('data-expired') === 'true';
                
                if (filter === 'all') {
                    $(this).show();
                } else if (filter === 'expired' && isExpired) {
                    $(this).show();
                } else if (filter === 'active' && !isExpired) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
        
        // Delete Record
        function deleteRecord(type, id, name) {
            if (!confirm(`Are you sure you want to delete this ${type}: ${name}?`)) {
                return;
            }
            
            $.ajax({
                url: `/api/admin/${type}/${id}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        // Show success message
                        const alertDiv = $(`
                            <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                                <i class="fas fa-trash-alt"></i> Record deleted successfully
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `);
                        $('body').append(alertDiv);
                        
                        // Auto-dismiss after 3 seconds
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 3000);
                        
                        // Reload data to refresh tables
                        setTimeout(() => {
                            loadAdminData();
                        }, 500);
                    } else {
                        alert('❌ Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Delete error:', xhr, status, error);
                    const errorMessage = xhr.responseJSON?.message || error;
                    alert('❌ Error deleting record: ' + errorMessage);
                }
            });
        }
        
        // ============ CALENDAR VIEW FUNCTIONS ============
        
        let currentWeekStart = new Date();
        
        // Get Monday of the current week
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
            return new Date(d.setDate(diff));
        }
        
        // Initialize calendar view
        function initCalendarView() {
            currentWeekStart = getMonday(new Date());
            renderWeekCalendar();
        }
        
        // Render the week calendar
        function renderWeekCalendar() {
            const startDate = new Date(currentWeekStart);
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            // Update week display
            const weekText = `${startDate.toLocaleDateString('id-ID')} - ${endDate.toLocaleDateString('id-ID')}`;
            $('#weekDisplay').text(weekText);
            $('#weekDatePicker').val(startDate.toISOString().split('T')[0]);
            
            // Render full calendar table
            renderCalendarTable(startDate);
        }
        
        // Render full calendar table (header + body)
        function renderCalendarTable(startDate) {
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // --- HEADER ---
            let headHtml = '<tr><th class="time-col">Jam</th>';
            const dayDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                dayDates.push(d);
                const isToday = d.toDateString() === today.toDateString();
                const monthNames = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
                const dateLabel = `${d.getDate()}-${monthNames[d.getMonth()]}-${d.getFullYear()}`;
                headHtml += `<th class="${isToday ? 'today-col' : ''}">
                    <span class="day-name">${days[i]}</span>
                    <span class="day-date">${dateLabel}</span>
                </th>`;
            }
            headHtml += '</tr>';
            $('#calendarHead').html(headHtml);
            
            // --- BODY ---
            const timeSlots = generateTimeSlots();
            const schedulesByDateTime = groupSchedulesByDateTime(window.calendarSchedules || [], startDate);
            window.scheduleItemMap = {};
            let counter = 0;
            
            let bodyHtml = '';
            timeSlots.forEach(time => {
                // Check if this row has any schedules
                let rowHasSchedules = false;
                for (let di = 0; di < 7; di++) {
                    const dk = dayDates[di].toISOString().split('T')[0];
                    if (schedulesByDateTime[`${dk}|${time}`]) { rowHasSchedules = true; break; }
                }
                const rowClass = rowHasSchedules ? '' : ' class="empty-row"';
                
                bodyHtml += `<tr${rowClass}>`;
                bodyHtml += `<td class="time-col">${time}</td>`;
                
                for (let di = 0; di < 7; di++) {
                    const dateKey = dayDates[di].toISOString().split('T')[0];
                    const isToday = dayDates[di].toDateString() === today.toDateString();
                    const slotHour = parseInt(time.split(':')[0]);
                    const isPast = dayDates[di] < today || (isToday && slotHour < new Date().getHours());
                    const cellKey = `${dateKey}|${time}`;
                    const schedules = schedulesByDateTime[cellKey] || [];
                    
                    let cellContent = '';
                    schedules.forEach(schedule => {
                        const trainerName = getTrainerName(schedule.trainer_id);
                        const className = getClassName(schedule.class_id);
                        const classInfo = getClassInfo(schedule.class_id);
                        const memberNames = getMemberNames(schedule.members);
                        const userCount = memberNames.length;
                        const capacity = classInfo ? parseInt(classInfo.capacity) || 0 : 0;
                        const duration = classInfo ? classInfo.duration : '';
                        const statusLower = (schedule.status || 'active').toLowerCase();
                        const bgClass = `bg-${statusLower}`;
                        const genderLabel = schedule.gender_restriction === 'M' ? '♂ Pria' : schedule.gender_restriction === 'F' ? '♀ Wanita' : '';
                        
                        const sid = 'sched-' + (counter++);
                        window.scheduleItemMap[sid] = schedule;
                        
                        // Build member list
                        let memberList = '';
                        if (userCount > 0) {
                            memberList = memberNames.map(n => `<div style="font-size:0.65rem;opacity:0.85;">• ${n}</div>`).join('');
                        }
                        
                        cellContent += `
                            <div class="schedule-item ${bgClass}" data-schedule-id="${sid}" onclick="event.stopPropagation(); editScheduleItem('${sid}')">
                                <button class="schedule-item-delete" onclick="event.stopPropagation(); deleteRecord('schedule','${schedule.id}','Schedule #${schedule.id}')" title="Hapus"><i class="fas fa-times"></i></button>
                                <div class="schedule-item-title">${className}${genderLabel ? '<span class="schedule-item-gender">' + genderLabel + '</span>' : ''}</div>
                                <div class="schedule-item-trainer"><i class="fas fa-user-tie"></i> ${trainerName}</div>
                                <div class="schedule-item-meta">
                                    ${duration ? '<span><i class="fas fa-clock"></i> ' + duration + ' min</span>' : ''}
                                    <span><i class="fas fa-users"></i> ${userCount}/${capacity}</span>
                                </div>
                                ${memberList}
                            </div>
                        `;
                    });
                    
                    const hasSchedule = schedules.length > 0;
                    const cellClass = `day-col${isToday ? ' today-col' : ''}${isPast ? ' past-col' : ''}${hasSchedule ? ' has-schedule' : ''}`;
                    if (isPast) {
                        bodyHtml += `<td class="${cellClass}">${cellContent}</td>`;
                    } else {
                        bodyHtml += `<td class="${cellClass}" onclick="showAddScheduleForCell('${dateKey}','${time}')" title="Klik untuk tambah jadwal">${cellContent}</td>`;
                    }
                }
                bodyHtml += '</tr>';
            });
            
            $('#calendarBody').html(bodyHtml);
        }
        
        // Generate time slots from 7:00 to 19:00
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 7; hour < 20; hour++) {
                slots.push(`${String(hour).padStart(2, '0')}:00`);
            }
            return slots;
        }
        
        // Group schedules by date and time
        function groupSchedulesByDateTime(schedules, startDate) {
            const grouped = {};
            
            schedules.forEach(schedule => {
                if (!schedule.schedule_time) return;
                
                const schedDateTime = new Date(schedule.schedule_time);
                const schedDate = schedDateTime.toISOString().split('T')[0];
                const schedTime = String(schedDateTime.getHours()).padStart(2, '0') + ':00';
                
                // Check if schedule is within the current week
                const weekEnd = new Date(startDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                if (schedDateTime >= startDate && schedDateTime <= weekEnd) {
                    const key = `${schedDate}|${schedTime}`;
                    if (!grouped[key]) {
                        grouped[key] = [];
                    }
                    grouped[key].push(schedule);
                }
            });
            
            return grouped;
        }
        
        // Get trainer name from ID
        function getTrainerName(trainerId) {
            if (!window.adminData || !window.adminData.trainers) return 'No Trainer';
            const trainer = window.adminData.trainers.find(t => t.id == trainerId);
            return trainer ? trainer.name : 'No Trainer';
        }
        
        // Get class name from ID
        function getClassName(classId) {
            if (!window.adminData || !window.adminData.classes) return 'No Class';
            const cls = window.adminData.classes.find(c => c.id == classId);
            return cls ? cls.name : 'No Class';
        }
        
        // Get full class info from ID
        function getClassInfo(classId) {
            if (!window.adminData || !window.adminData.classes) return null;
            return window.adminData.classes.find(c => c.id == classId) || null;
        }
        
        // Get member names from comma-separated IDs
        function getMemberNames(membersStr) {
            if (!membersStr || !window.adminData || !window.adminData.users) return [];
            
            // Try to parse as JSON array first, fallback to comma-separated
            let ids = [];
            try {
                ids = JSON.parse(membersStr);
            } catch (e) {
                // Not JSON, treat as comma-separated string
                ids = membersStr.split(',').map(s => s.trim()).filter(Boolean);
            }
            
            return ids.map(id => {
                const user = window.adminData.users.find(u => u.id == id);
                return user ? user.name : 'User #' + id;
            });
        }
        
        // Previous week button
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderWeekCalendar();
        }
        
        // Next week button
        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderWeekCalendar();
        }
        
        // Go to today button
        function goToToday() {
            currentWeekStart = getMonday(new Date());
            renderWeekCalendar();
        }
        
        // Go to selected date
        function goToDate() {
            const dateStr = $('#weekDatePicker').val();
            if (dateStr) {
                const selectedDate = new Date(dateStr);
                currentWeekStart = getMonday(selectedDate);
                renderWeekCalendar();
            }
        }
        
        // Show add schedule modal
        function showAddScheduleModal() {
            showAddModal('schedule');
        }
        
        // Show add schedule modal with pre-filled date and time from calendar cell
        function showAddScheduleForCell(dateStr, time) {
            // dateStr = "2026-02-13", time = "16:00"
            const prefilledDateTime = `${dateStr}T${time}`;
            
            $('#recordId').val('');
            $('#recordType').val('schedule');
            $('#crudModalTitle').text('Add New Schedule');
            
            // Generate form with pre-filled schedule_time
            generateFormFields('schedule', { schedule_time: prefilledDateTime });
            
            $('#crudModal').modal('show');
        }
        
        // Edit schedule item from calendar
        function editScheduleItem(scheduleId) {
            const schedule = window.scheduleItemMap[scheduleId];
            if (schedule) {
                editRecord('schedule', schedule);
            } else {
                alert('Error: Schedule data not found');
            }
        }
    </script>
</body>
</html>
