<!-- Account/Dashboard Section -->
<section class="account-area" style="background: linear-gradient(180deg, #8b7355 0%, #d4c5b0 50%, #e8dcc8 100%); min-height: 100vh; padding: 100px 0 40px 0;">
  <!-- Info Bar -->
  <div class="info-bar" style="background: #9d8c7a; padding: 12px 0; margin-bottom: 30px;">
    <div class="container">
      <div class="d-flex align-items-center justify-content-center">
        <i class="fi fi-rs-info" style="color: white; margin-right: 10px; font-size: 18px;"></i>
        <span style="color: white; font-size: 14px;">The schedule displays times in WIB (Waktu Indonesia Barat, GMT+7 Jakarta)</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <!-- Left Sidebar - Calendar & Status -->
      <div class="col-lg-4 col-md-5 mb-4">
        <!-- User Greeting -->
        <div class="user-greeting mb-3" style="background: transparent; padding: 15px 0; display: flex; align-items: center;">
          <i class="fi fi-rs-user" style="color: #4a3829; font-size: 24px; margin-right: 10px;"></i>
          <div>
            <p style="margin: 0; color: #4a3829; font-size: 14px;">Hello,</p>
            <h4 style="margin: 0; color: #4a3829; font-weight: 600; font-size: 20px;">{{user.name}}</h4>
          </div>
        </div>

        <!-- Calendar Card -->
        <div class="calendar-card" style="background: #f5f0e8; border: 2px solid #4a3829; border-radius: 25px; padding: 25px; margin-bottom: 20px;">
          <div class="d-flex align-items-center mb-3">
            <i class="fi fi-rs-calendar" style="color: #8b6f47; font-size: 24px; margin-right: 10px;"></i>
            <h5 style="margin: 0; color: #4a3829; font-weight: 600;" id="calendar-title">19 Desember 2025</h5>
          </div>
          
          <!-- Mini Calendar -->
          <div class="mini-calendar" style="background: white; border-radius: 15px; padding: 15px;">
            <div class="calendar-header" style="display: flex; justify-content-between; align-items: center; margin-bottom: 15px;">
              <button id="prev-month" style="border: none; background: transparent; cursor: pointer; font-size: 20px; color: #8b6f47;">‹</button>
              <span id="current-month-year" style="font-weight: 600; color: #4a3829;">December 2025</span>
              <button id="next-month" style="border: none; background: transparent; cursor: pointer; font-size: 20px; color: #8b6f47;">›</button>
            </div>
            <div class="calendar-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center;">
              <div style="font-size: 11px; color: #666; font-weight: 600;">Sun</div>
              <div style="font-size: 11px; color: #666; font-weight: 600;">Mon</div>
              <div style="font-size: 11px; color: #666; font-weight: 600;">Tue</div>
              <div style="font-size: 11px; color: #666; font-weight: 600;">Wed</div>
              <div style="font-size: 11px; color: #666; font-weight: 600;">Thu</div>
              <div style="font-size: 11px; color: #666; font-weight: 600;">Fri</div>
              <div style="font-size: 11px; color: #666; font-weight: 600;">Sat</div>
            </div>
            <div class="calendar-dates" id="calendar-dates" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; margin-top: 10px;">
              <!-- Dates will be populated by JavaScript -->
            </div>
          </div>
          
          <div class="mt-3 text-center">
            <button id="show-more-dates" style="background: transparent; border: 1px solid #8b6f47; color: #8b6f47; padding: 8px 20px; border-radius: 20px; font-size: 13px; cursor: pointer;">Show More Date</button>
          </div>
        </div>

        <!-- Booking Status Card -->
        <div class="status-card" style="background: #f5f0e8; border: 2px solid #4a3829; border-radius: 25px; padding: 25px; margin-bottom: 20px;">
          <h6 style="color: #4a3829; font-weight: 600; margin-bottom: 5px;">Membership Status</h6>
          <p style="color: #666; font-size: 13px; margin-bottom: 5px;">Expired Date:</p>
          <p id="expired-date-display" style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">{{user.expired_date}}</p>
          <h6 style="color: #4a3829; font-weight: 600; margin-bottom: 15px; margin-top: 20px;" id="status-class-type">Reguler</h6>
          <div class="status-info" style="background: white; border-radius: 12px; padding: 15px;">
            <div class="d-flex justify-content-between mb-2">
              <span style="color: #666; font-size: 13px;">Kuota Total :</span>
              <span style="color: #4a3829; font-weight: 600;" id="status-total">0</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span style="color: #666; font-size: 13px;">Terpakai :</span>
              <span style="color: #4a3829; font-weight: 600;" id="status-used">0</span>
            </div>
            <div class="d-flex justify-content-between">
              <span style="color: #666; font-size: 13px;">Sisa :</span>
              <span style="color: #8b6f47; font-weight: 600;" id="status-remaining">0</span>
            </div>
          </div>
        </div>

        <!-- Chat with Admin Button -->
        <div class="text-center">
            <a href="https://wa.me/6282121121328" target="_blank" style="text-decoration: none; display: block;">
            <button style="background: #4a3829; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer; width: 100%;">
              <i class="fi fi-brands-whatsapp" style="margin-right: 8px;"></i>Chat with Admin
            </button>
            </a>
        </div>
      </div>

      <!-- Right Content - Class List -->
      <div class="col-lg-8 col-md-7">
        <!-- Tabs -->
        <div class="tabs mb-3" style="display: flex; gap: 10px; justify-content: center;">
          <button class="tab-btn active" data-tab="upcoming" style="background: #d4c5b0; color: #4a3829; border: none; padding: 10px 30px; border-radius: 20px; font-weight: 600; cursor: pointer;">
            Upcoming
          </button>
          <button class="tab-btn" data-tab="history" style="background: #9d8c7a; color: white; border: none; padding: 10px 30px; border-radius: 20px; font-weight: 600; cursor: pointer;">
            History
          </button>
        </div>

        <!-- Classes List -->
        <div class="classes-list" id="classes-list">
          <!-- Class cards will be populated by JavaScript -->
          
          <!-- Sample Class Card Template (Hidden, used by JS) -->
          <div class="class-card-template" style="display: none;">
            <div class="class-card" style="background: white; border: 2px solid #4a3829; border-radius: 25px; padding: 25px; margin-bottom: 15px; position: relative;">
              <div class="row align-items-center">
                <div class="col-md-9">
                  <div class="d-flex align-items-start">
                    <!-- Time Badge -->
                    <div class="time-badge" style="background: #4a3829; color: white; border-radius: 15px; padding: 15px; text-align: center; min-width: 80px; margin-right: 20px;">
                      <div style="font-size: 11px; opacity: 0.8; margin-bottom: 3px;">Jumat</div>
                      <div style="font-size: 10px; background: #8b6f47; border-radius: 10px; padding: 3px 8px; margin-bottom: 5px; display: inline-block;">19 Dec</div>
                      <div style="font-size: 20px; font-weight: bold;">07.00</div>
                      <div style="font-size: 11px; margin-top: 3px;">60 mins</div>
                    </div>
                    
                    <!-- Class Info -->
                    <div class="class-info">
                      <h5 style="color: #4a3829; font-weight: 600; margin-bottom: 5px; font-size: 18px;">Reguler Reformer (Basic/Intermediate)</h5>
                      <div class="class-meta" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                        <div style="display: flex; align-items: center;">
                          <i class="fi fi-rs-user" style="color: #8b6f47; margin-right: 5px;"></i>
                          <span style="color: #666; font-size: 14px;">Kim Davis</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                          <i class="fi fi-rs-venus" style="color: #8b6f47; margin-right: 5px;"></i>
                          <span style="color: #666; font-size: 14px;">Female Only</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                          <span style="background: #e8f5e9; color: #2e7d32; padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600;">3/6</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-3 text-end">
                  <button class="book-btn" style="background: #4a3829; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; width: 100%;">
                    Book Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Full Calendar Modal -->
<div id="calendar-modal" class="calendar-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
  <div class="calendar-modal-content" style="background: #f5f0e8; border-radius: 30px; padding: 40px; max-width: 500px; width: 90%; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <!-- Close Button -->
    <button id="close-calendar-modal" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 28px; color: #4a3829; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s;">
      ×
    </button>

    <!-- Month/Year Header -->
    <div class="modal-calendar-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
      <button id="modal-prev-month" style="border: none; background: transparent; cursor: pointer; font-size: 24px; color: #4a3829; padding: 10px;">‹</button>
      <div style="background: #4a3829; color: white; padding: 12px 30px; border-radius: 25px; font-weight: 600; font-size: 18px; display: flex; align-items: center; gap: 5px;">
        <span id="modal-month-year">December</span>
        <span>▼</span>
        <span id="modal-year">2025</span>
      </div>
      <button id="modal-next-month" style="border: none; background: transparent; cursor: pointer; font-size: 24px; color: #4a3829; padding: 10px;">›</button>
    </div>

    <!-- Calendar Grid -->
    <div class="modal-calendar-grid">
      <!-- Day Headers -->
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 15px; text-align: center;">
        <div style="font-size: 14px; color: #666; font-weight: 600;">Sun</div>
        <div style="font-size: 14px; color: #666; font-weight: 600;">Mon</div>
        <div style="font-size: 14px; color: #666; font-weight: 600;">Tue</div>
        <div style="font-size: 14px; color: #666; font-weight: 600;">Wed</div>
        <div style="font-size: 14px; color: #666; font-weight: 600;">Thu</div>
        <div style="font-size: 14px; color: #666; font-weight: 600;">Fri</div>
        <div style="font-size: 14px; color: #666; font-weight: 600;">Sat</div>
      </div>
      
      <!-- Calendar Dates -->
      <div id="modal-calendar-dates" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; text-align: center;">
        <!-- Dates will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Booking Confirmation Modal -->
<div id="booking-modal" class="booking-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
  <div class="booking-modal-content" style="background: white; border-radius: 30px; padding: 40px; max-width: 450px; width: 90%; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.4); text-align: center;">
    <!-- Trainer Image -->
    <div style="margin-bottom: 20px;">
      <img id="booking-trainer-img" src="" alt="Trainer" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid #4a3829;">
    </div>
    
    <!-- Class Info -->
    <h3 id="booking-class-name" style="color: #4a3829; margin-bottom: 5px; font-size: 24px; font-weight: 700;">Yoga</h3>
    <p id="booking-class-type" style="color: #666; margin-bottom: 5px; font-size: 16px;">Vinyasa Yoga</p>
    <p id="booking-trainer-name" style="color: #666; margin-bottom: 15px; font-size: 14px;">Trainer : Stephani Karnadi</p>
    
    <!-- Date & Time -->
    <h4 id="booking-datetime" style="color: #4a3829; margin-bottom: 20px; font-size: 18px; font-weight: 600;">Sabtu, 27 Desember 2025<br>Jam 07.00</h4>
    
    <!-- Credits Info -->
    <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 15px; padding: 15px; margin-bottom: 20px;">
      <p style="color: #2e7d32; margin: 0; font-size: 14px;">
        <i class="fas fa-coins"></i> Credits Required: <span id="booking-credits-required" style="font-weight: bold;">-</span>
      </p>
      <p style="color: #2e7d32; margin: 5px 0 0 0; font-size: 14px;">
        <i class="fas fa-wallet"></i> Your Credits: <span id="booking-credits-available" style="font-weight: bold;">-</span>
      </p>
    </div>
    
    <!-- Warning Message -->
    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
      <h2 style="color: #856404; margin: 0 0 10px 0; font-size: 22px; font-weight: 700;">PERHATIAN!!!</h2>
      <p style="color: #856404; margin: 0; font-size: 14px; line-height: 1.6;">Pembatalan jadwal maksimal H-3!<br>Apakah kamu yakin akan mengambil kelas ini?</p>
    </div>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 15px; justify-content: center;">
      <button id="confirm-booking-btn" style="background: #4a3829; color: white; border: none; padding: 12px 35px; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; flex: 1;">
        <i class="fi fi-rs-check" style="margin-right: 5px;"></i> Book Now
      </button>
      <button id="cancel-booking-btn" style="background: #6c757d; color: white; border: none; padding: 12px 35px; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; flex: 1;">
        <i class="fi fi-rs-cross" style="margin-right: 5px;"></i> Close
      </button>
    </div>
  </div>
</div>

<style>
  .tab-btn.active {
    background: #d4c5b0 !important;
    color: #4a3829 !important;
  }
  
  .calendar-date {
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    font-size: 14px;
    transition: all 0.3s ease;
    width: 32px;
    height: 32px;
  }
  
  .calendar-date:hover {
    background: #e8dcc8;
  }
  
  .calendar-date.selected {
    background: #8b6f47;
    color: white;
    font-weight: bold;
  }
  
  .calendar-date.today {
    border: 2px solid #8b6f47;
  }

  .calendar-modal {
    display: none;
  }

  .calendar-modal.show {
    display: flex !important;
  }

  .booking-modal {
    display: none;
  }

  .booking-modal.show {
    display: flex !important;
  }

  #confirm-booking-btn:hover {
    background: #6d5a47;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  #cancel-booking-btn:hover {
    background: #5a6268;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  .modal-calendar-date {
    cursor: pointer;
    padding: 12px 8px;
    border-radius: 50%;
    font-size: 16px;
    transition: all 0.3s ease;
    color: #4a3829;
    font-weight: 500;
  }

  .modal-calendar-date:hover {
    background: #e8dcc8;
  }

  .modal-calendar-date.selected {
    background: #4a3829;
    color: white;
    font-weight: bold;
  }

  .modal-calendar-date.other-month {
    color: #ccc;
  }

  .modal-calendar-date.disabled {
    color: #ddd;
    cursor: not-allowed;
  }

  #close-calendar-modal:hover {
    background: rgba(0,0,0,0.1);
  }

  @media (max-width: 768px) {
    .account-area {
      padding: 80px 0 20px 0 !important;
    }
    
    .time-badge {
      min-width: 70px !important;
      padding: 12px !important;
    }
    
    .class-card .row {
      flex-direction: column;
    }
    
    .class-card .col-md-3 {
      margin-top: 15px;
    }
  }
</style>

<script>
// Initialize date and classes data
let selectedDate = new Date(); // Current date - today
let currentWeekStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1); // Start at first day of current month
let modalCurrentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1); // Current month
let currentTab = 'upcoming'; // upcoming or history
let classesData = [];

// API endpoints (adjust based on your backend)
const API_BASE = '/api/admin/data';

// Check if user membership is expired
const userExpiredDate = '{{user.expired_date}}';
let isUserExpired = false;

if (userExpiredDate && userExpiredDate !== '') {
  const expiredDate = new Date(userExpiredDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  expiredDate.setHours(0, 0, 0, 0);
  
  isUserExpired = expiredDate < today;
  
  // Update expired date color based on status
  const expiredDateElement = document.getElementById('expired-date-display');
  if (expiredDateElement) {
    if (isUserExpired) {
      expiredDateElement.style.color = '#d32f2f'; // Red if expired
    } else {
      expiredDateElement.style.color = '#000000'; // Black if not expired
    }
  }
  
  console.log('User expired check:', {
    expiredDate: userExpiredDate,
    today: today.toISOString().split('T')[0],
    isExpired: isUserExpired
  });
  
  // Show alert if expired
  if (isUserExpired) {
    setTimeout(() => {
      alert('⚠️ PERHATIAN!\n\nMembership Anda telah expired pada ' + userExpiredDate + '.\n\nAnda tidak dapat melakukan booking class.\nSilakan hubungi admin untuk perpanjangan membership.');
    }, 500);
  }
}

// Helper function to format date to YYYY-MM-DD without timezone issues
function formatDateToString(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Cache for trainers and classes data (fetched once)
let trainersCache = null;
let classesCache = null;

// Fetch trainers and classes lookup data (once)
async function fetchLookupData() {
  if (trainersCache && classesCache) return;
  
  try {
    const [trainersRes, classesRes] = await Promise.all([
      fetch(`${API_BASE}/trainers`),
      fetch(`${API_BASE}/classes`)
    ]);
    
    const trainersData = await trainersRes.json();
    const classesDataRes = await classesRes.json();
    
    if (trainersData.success) trainersCache = trainersData.data;
    if (classesDataRes.success) classesCache = classesDataRes.data;
  } catch (error) {
    console.error('Error fetching lookup data:', error);
    trainersCache = trainersCache || [];
    classesCache = classesCache || [];
  }
}

// Fetch schedule data from admin API
async function fetchSchedule(date, isHistory = false) {
  const dateStr = formatDateToString(date);
  console.log('Fetching schedule for date:', dateStr, 'isHistory:', isHistory);
  
  // Show loading
  const listContainer = document.getElementById('classes-list');
  listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><i class="fi fi-rs-spinner" style="font-size: 32px; display: block; margin-bottom: 10px;"></i>Loading schedules...</div>';
  
  try {
    // Ensure lookup data is loaded
    await fetchLookupData();
    
    if (isHistory) {
      // History still uses the old schedule API
      const response = await fetch('/api/schedule/history');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      classesData = (data.schedule || []).map(s => {
        s.isPast = true;
        s.isBookable = false;
        return s;
      });
      renderClasses();
      updateStatusCard();
      return;
    }
    
    // Fetch schedules with week filter
    const response = await fetch(`${API_BASE}/schedules?date=${dateStr}`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    
    // Also fetch user's bookings to check booked status
    let userBookedSids = [];
    try {
      const bookingsRes = await fetch(`/api/schedule?date=${dateStr}`);
      if (bookingsRes.ok) {
        const bookingsData = await bookingsRes.json();
        userBookedSids = (bookingsData.schedule || [])
          .filter(s => s.booked === '1' || s.bookclass === 'booked')
          .map(s => s.sid);
      }
    } catch (e) { console.log('Could not fetch user bookings:', e); }
    
    // Filter schedules for the selected date only
    const schedulesForDate = (data.data || []).filter(s => {
      if (!s.schedule_time) return false;
      if (!s.id) {
        console.warn('Schedule missing ID, skipping:', s);
        return false;
      }
      const st = new Date(s.schedule_time);
      if (isNaN(st.getTime())) return false;
      const stDateStr = formatDateToString(st);
      return stDateStr === dateStr && (s.status === 'Active' || s.status === '');
    });
    
    // Build enriched schedule objects
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const now = new Date();
    const selectedDateOnly = new Date(selectedDate);
    selectedDateOnly.setHours(0, 0, 0, 0);
    const sevenDaysLater = new Date(today);
    sevenDaysLater.setDate(today.getDate() + 7);
    sevenDaysLater.setHours(0, 0, 0, 0);
    const isBookableDate = selectedDateOnly.getTime() >= today.getTime() && selectedDateOnly.getTime() <= sevenDaysLater.getTime();
    
    classesData = schedulesForDate.map(s => {
      const trainer = (trainersCache || []).find(t => t.id === s.trainer_id) || {};
      const classInfo = (classesCache || []).find(c => c.id === s.class_id) || {};
      
      let membersArray = [];
      if (s.members && s.members.trim()) {
        try { 
          membersArray = JSON.parse(s.members); 
        } catch(e) { 
          // Not valid JSON — treat as comma-separated string
          membersArray = s.members.split(',').map(m => m.trim()).filter(m => m !== '');
        }
      }
      
      const classDateTime = new Date(s.schedule_time);
      const duration = parseInt(classInfo.duration) || 60;
      const classEndTime = new Date(classDateTime.getTime() + duration * 60000);
      
      let isPast = false;
      let isRunning = false;
      if (selectedDateOnly.getTime() === today.getTime()) {
        isPast = classEndTime <= now;
        isRunning = classDateTime <= now && now < classEndTime;
      } else if (selectedDateOnly < today) {
        isPast = true;
      }
      
      const isBooked = userBookedSids.includes(s.id);
      
      // Debug: log schedule id
      if (!s.id) {
        console.warn('Schedule missing ID:', s);
      }
      
      return {
        sid: s.id,
        stime: s.schedule_time,
        strain: s.trainer_id,
        sclass: s.class_id,
        smember: s.members,
        sgender: s.gender_restriction || '',
        snotes: s.notes || '',
        aname: trainer.name || '',
        aimg: trainer.image || '',
        cname: classInfo.name || '',
        cdur: classInfo.duration || '60',
        ccap: classInfo.capacity || '6',
        scap: membersArray.length,
        booked: isBooked ? '1' : '0',
        bookclass: isBooked ? 'booked' : '',
        isPast: isPast || isRunning,
        isBookable: isBookableDate && !isPast && !isRunning,
        credits_required: classInfo.credits_required || 1,
        total_credits: window.userCredits || 0
      };
    });
    
    renderScheduleGrid();
    updateStatusCard();
    
  } catch (error) {
    console.error('Error fetching schedule:', error);
    classesData = [];
    renderScheduleGrid();
    updateStatusCard();
  }
}

// No more fallback data - schedule list comes from the database via API

// Helper: resolve trainer image URL (API may return just filename like "u-3.webp")
function resolveTrainerImage(img) {
  if (!img) return 'https://homepilatesstudio.com/uploads/users/u-156.webp';
  if (img.startsWith('http://') || img.startsWith('https://')) return img;
  return `https://homepilatesstudio.com/uploads/${img}`;
}

// Format date
function formatDate(date) {
  const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
  const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
  return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function formatShortDate(date) {
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  return `${days[date.getDay()]} ${date.getDate()}`;
}

// Render calendar
function renderCalendar() {
  const datesContainer = document.getElementById('calendar-dates');
  datesContainer.innerHTML = '';
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Get current month being displayed
  const year = currentWeekStart.getFullYear();
  const month = currentWeekStart.getMonth();
  
  // Update month-year display
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('current-month-year').textContent = `${months[month]} ${year}`;
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();
  
  // Add previous month's trailing days (dimmed)
  for (let i = firstDay - 1; i >= 0; i--) {
    const prevMonthDate = new Date(year, month - 1, daysInPrevMonth - i);
    const dateDiv = document.createElement('div');
    dateDiv.className = 'calendar-date';
    dateDiv.textContent = daysInPrevMonth - i;
    dateDiv.style.opacity = '0.3';
    dateDiv.style.cursor = 'default';
    
    datesContainer.appendChild(dateDiv);
  }
  
  // Add current month's days
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    date.setHours(0, 0, 0, 0);
    
    const dateDiv = document.createElement('div');
    dateDiv.className = 'calendar-date';
    dateDiv.textContent = day;
    
    if (date.toDateString() === selectedDate.toDateString()) {
      dateDiv.classList.add('selected');
    }
    
    if (date.toDateString() === today.toDateString()) {
      dateDiv.classList.add('today');
    }
    
    dateDiv.onclick = () => {
      selectedDate = date;
      renderCalendar();
      updateCalendarTitle();
      fetchSchedule(selectedDate, currentTab === 'history');
    };
    
    datesContainer.appendChild(dateDiv);
  }
  
  // Add next month's leading days (dimmed)
  const totalCells = firstDay + daysInMonth;
  const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  
  for (let day = 1; day <= remainingCells; day++) {
    const nextMonthDate = new Date(year, month + 1, day);
    const dateDiv = document.createElement('div');
    dateDiv.className = 'calendar-date';
    dateDiv.textContent = day;
    dateDiv.style.opacity = '0.3';
    dateDiv.style.cursor = 'default';
    
    datesContainer.appendChild(dateDiv);
  }
}

// Update calendar title
function updateCalendarTitle() {
  document.getElementById('calendar-title').textContent = formatDate(selectedDate);
}

// Render schedule grid - shows all time slots 08:00 to 16:00
function renderScheduleGrid() {
  const listContainer = document.getElementById('classes-list');
  listContainer.innerHTML = '';
  
  // If history tab, use old card-based rendering
  if (currentTab === 'history') {
    renderClasses();
    return;
  }
  
  const timeSlots = [8, 9, 10, 11, 12, 13, 14, 15, 16]; // 08:00 - 16:00
  const dateStr = formatDateToString(selectedDate);
  const dayIndo = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][selectedDate.getDay()];
  const monthShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][selectedDate.getMonth()];
  
  timeSlots.forEach(hour => {
    const hourStr = hour.toString().padStart(2, '0');
    
    // Find schedule(s) matching this hour
    const matchingSchedules = classesData.filter(s => {
      const sDate = new Date(s.stime);
      return sDate.getHours() === hour;
    });
    
    const hasSchedule = matchingSchedules.length > 0;
    
    if (hasSchedule) {
      // Render each schedule at this hour
      matchingSchedules.forEach(schedule => {
        const card = createScheduleCard(schedule, dayIndo, monthShort);
        listContainer.appendChild(card);
      });
    } else {
      // Render disabled/empty slot
      const emptyCard = document.createElement('div');
      emptyCard.className = 'class-card disabled-slot';
      emptyCard.style = 'background: #f0ece5; border: 2px dashed #c4b8a8; border-radius: 25px; padding: 20px 25px; margin-bottom: 10px; opacity: 0.6;';
      
      emptyCard.innerHTML = `
        <div class="row align-items-center">
          <div class="col-md-9">
            <div class="d-flex align-items-center">
              <div class="time-badge" style="background: #9d8c7a; color: white; border-radius: 15px; padding: 12px; text-align: center; min-width: 80px; margin-right: 20px;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 3px;">${dayIndo}</div>
                <div style="font-size: 10px; background: #b5a594; border-radius: 10px; padding: 3px 8px; margin-bottom: 5px; display: inline-block;">${selectedDate.getDate()} ${monthShort}</div>
                <div style="font-size: 20px; font-weight: bold;">${hourStr}.00</div>
              </div>
              <div class="class-info">
                <h5 style="color: #999; font-weight: 500; margin: 0; font-size: 16px;">Tidak ada jadwal</h5>
                <p style="color: #bbb; font-size: 13px; margin: 5px 0 0;">No schedule available at this time</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 text-end">
            <button disabled style="background: #ccc; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: not-allowed; width: 100%; font-size: 13px;">
              Not Available
            </button>
          </div>
        </div>
      `;
      
      listContainer.appendChild(emptyCard);
    }
  });

  attachCardEventListeners();
}

// Create a schedule card for an active time slot
function createScheduleCard(schedule, dayIndo, monthShort) {
  // Validate schedule has required ID
  if (!schedule.sid) {
    console.error('Schedule missing sid:', schedule);
    return document.createElement('div'); // Return empty div
  }
  
  const card = document.createElement('div');
  card.className = 'class-card';
  card.style = 'background: white; border: 2px solid #4a3829; border-radius: 25px; padding: 25px; margin-bottom: 10px;';
  
  const scheduleDate = new Date(schedule.stime);
  const hours = scheduleDate.getHours().toString().padStart(2, '0');
  const minutes = scheduleDate.getMinutes().toString().padStart(2, '0');
  const timeStr = `${hours}.${minutes}`;
  
  const classNotes = schedule.snotes ? schedule.snotes.replace(/\n/g, ' ').trim() : '';
  const fullClassName = `${schedule.cname} ${classNotes}`.trim();
  
  const slotsUsed = parseInt(schedule.scap) || 0;
  const slotsTotal = parseInt(schedule.ccap) || 6;
  const slotsDisplay = `${slotsUsed}/${slotsTotal}`;
  
  const isBooked = schedule.booked === "1" || schedule.bookclass === "booked";
  const isFull = slotsUsed >= slotsTotal;
  const isPast = schedule.isPast === true;
  const isBookable = schedule.isBookable !== false;
  
  let genderIcon = 'fi-rs-briefcase';
  let genderText = 'All Class';
  let genderColor = '#8b6f47';
  
  if (schedule.sgender === 'F') {
    genderIcon = 'fi-rs-venus';
    genderText = 'Female Only';
    genderColor = '#e91e63';
  } else if (schedule.sgender === '') {
    genderText = 'Mixed Class';
  }
  
  let buttonHTML = '';
  if (isUserExpired) {
    buttonHTML = `<button class="expired-btn" style="background: #d32f2f; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; width: 100%;">Membership Expired</button>`;
  } else if (isBooked) {
    buttonHTML = `<button class="cancel-btn" data-sid="${schedule.sid}" style="background: #d32f2f; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; width: 100%;">Cancel Book</button>`;
  } else if (isPast) {
    buttonHTML = `<button class="past-btn" style="background: #9e9e9e; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; width: 100%;">Selesai</button>`;
  } else if (isFull) {
    buttonHTML = `<button disabled style="background: #ccc; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: not-allowed; width: 100%;">Full</button>`;
  } else if (!isBookable) {
    buttonHTML = `<button class="future-btn" style="background: #ff9800; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; width: 100%;">Terlalu Jauh</button>`;
  } else {
    buttonHTML = `<button class="book-btn" data-sid="${schedule.sid}" style="background: #4a3829; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; width: 100%;">Book Now</button>`;
  }
  
  card.innerHTML = `
    <div class="row align-items-center">
      <div class="col-md-9">
        <div class="d-flex align-items-start">
          <div class="time-badge" style="background: #4a3829; color: white; border-radius: 15px; padding: 15px; text-align: center; min-width: 100px; margin-right: 20px;">
            <div style="font-size: 11px; opacity: 0.8; margin-bottom: 3px;">${dayIndo}</div>
            <div style="font-size: 10px; background: #8b6f47; border-radius: 10px; padding: 3px 8px; margin-bottom: 5px; display: inline-block;">${scheduleDate.getDate()} ${monthShort}</div>
            <div style="font-size: 20px; font-weight: bold;">${timeStr}</div>
            <div style="font-size: 11px; margin-top: 3px;">${schedule.cdur} mins</div>
          </div>
          <div class="class-info">
            <h5 style="color: #4a3829; font-weight: 600; margin-bottom: 5px; font-size: 18px;">${fullClassName}</h5>
            <div class="class-meta" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
              <div style="display: flex; align-items: center; width: 100%;">
                <i class="fi fi-rs-user" style="color: #8b6f47; margin-right: 5px;"></i>
                <span style="color: #666; font-size: 14px;">${schedule.aname}</span>
              </div>
              <div style="display: flex; align-items: center; width: 100%;">
                <i class="fi ${genderIcon}" style="color: ${genderColor}; margin-right: 5px;"></i>
                <span style="color: ${genderColor}; font-size: 14px;">${genderText}</span>
              </div>
              <div style="display: flex; align-items: center; width: 100%;">
                <span style="background: ${isFull ? '#ffebee' : '#e8f5e9'}; color: ${isFull ? '#c62828' : '#2e7d32'}; padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600;">${slotsDisplay}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 text-end">
        ${buttonHTML}
      </div>
    </div>
  `;
  
  return card;
}

// Render classes for history tab (card-based, no time grid)
function renderClasses() {
  const listContainer = document.getElementById('classes-list');
  listContainer.innerHTML = '';
  
  if (classesData.length === 0) {
    listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><i class="fi fi-rs-calendar-xmark" style="font-size: 48px; margin-bottom: 15px; display: block;"></i><strong>No classes available</strong></div>';
    return;
  }
  
  classesData.forEach((schedule) => {
    const scheduleDate = new Date(schedule.stime);
    const dayIndo = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][scheduleDate.getDay()];
    const monthShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][scheduleDate.getMonth()];
    const card = createScheduleCard(schedule, dayIndo, monthShort);
    listContainer.appendChild(card);
  });
  
  attachCardEventListeners();
}

// Attach event listeners to schedule cards
function attachCardEventListeners() {
  const bookButtons = document.querySelectorAll('.book-btn:not([disabled])');
  console.log('Attaching listeners to', bookButtons.length, 'book buttons');
  
  bookButtons.forEach(btn => {
    const sid = btn.dataset.sid;
    console.log('Book button found with sid:', sid);
    btn.addEventListener('click', () => handleBookClass(sid));
  });
  
  document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', () => handleCancelBook(btn.dataset.sid));
  });
  
  document.querySelectorAll('.past-btn').forEach(btn => {
    btn.addEventListener('click', () => { alert('Kelas sudah selesai!'); });
  });
  
  document.querySelectorAll('.expired-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      alert('⚠️ Membership Anda telah expired!\n\nAnda tidak dapat melakukan booking class.\nSilakan hubungi admin untuk perpanjangan membership melalui WhatsApp.');
    });
  });
  
  document.querySelectorAll('.future-btn').forEach(btn => {
    btn.addEventListener('click', () => { alert('Kelas hanya bisa dibooking maksimal 8 hari kedepan!'); });
  });
}

// Show booking confirmation modal
let pendingBookingSid = null;
let pendingBookingData = null;

function showBookingModal(sid) {
  console.log('showBookingModal called with sid:', sid);
  
  // Find the class data
  const classData = classesData.find(c => c.sid === sid);
  if (!classData) {
    console.error('Class data not found for sid:', sid);
    alert('Error: Class data not found');
    return;
  }
  
  console.log('Found class data:', classData);
  pendingBookingSid = sid;
  pendingBookingData = classData;
  
  // Parse schedule date
  const scheduleDate = new Date(classData.stime);
  const hours = scheduleDate.getHours().toString().padStart(2, '0');
  const minutes = scheduleDate.getMinutes().toString().padStart(2, '0');
  const timeStr = `${hours}.${minutes}`;
  
  const dayIndo = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][scheduleDate.getDay()];
  const monthIndo = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][scheduleDate.getMonth()];
  
  // Update modal content
  document.getElementById('booking-trainer-img').src = resolveTrainerImage(classData.aimg);
  document.getElementById('booking-class-name').textContent = classData.cname || 'Class';
  document.getElementById('booking-class-type').textContent = classData.snotes ? classData.snotes.replace(/\n/g, ' ').trim() : '';
  document.getElementById('booking-trainer-name').textContent = `Trainer : ${classData.aname || 'Unknown'}`;
  document.getElementById('booking-datetime').innerHTML = `${dayIndo}, ${scheduleDate.getDate()} ${monthIndo} ${scheduleDate.getFullYear()}<br>Jam ${timeStr}`;
  
  // Update credits info
  const creditsRequired = classData.credits_required || 1;
  const creditsAvailable = classData.total_credits || 0;
  document.getElementById('booking-credits-required').textContent = creditsRequired;
  document.getElementById('booking-credits-available').textContent = creditsAvailable;
  
  // Show modal
  document.getElementById('booking-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeBookingModal() {
  document.getElementById('booking-modal').classList.remove('show');
  document.body.style.overflow = 'auto';
  pendingBookingSid = null;
  pendingBookingData = null;
}

// Fetch user's total credits information
async function fetchUserCredits() {
  try {
    const response = await fetch('/api/schedule/user/profile');
    if (!response.ok) {
      console.error('Failed to fetch user profile:', response.status);
      return null;
    }
    const data = await response.json();
    console.log('User profile data:', data);
    
    // Store total credits in global variable for use in showBookingModal
    window.userCredits = data.total_credits || 0;
    
    return data;
  } catch (error) {
    console.error('Error fetching user profile:', error);
    return null;
  }
}

// Update status card with user credit data
function updateStatusCard() {
  // For now, show class-related info
  // Credit display will be updated separately via fetchUserCredits
  if (classesData.length > 0) {
    const firstClass = classesData[0];
    document.getElementById('status-class-type').textContent = firstClass.cname || 'Reguler';
  } else {
    document.getElementById('status-class-type').textContent = '-';
  }
}

// Handle book class - now opens modal instead of using confirm
function handleBookClass(sid) {
  // Check if user membership is expired
  if (isUserExpired) {
    alert('⚠️ Membership Anda telah expired!\n\nAnda tidak dapat melakukan booking class.\nSilakan hubungi admin untuk perpanjangan membership.');
    return;
  }
  showBookingModal(sid);
}

// Handle cancel booking
async function handleCancelBook(sid) {
  console.log('handleCancelBook called with sid:', sid);
  if (!confirm('Are you sure you want to cancel this booking?')) return;
  
  try {
    const requestBody = { sid };
    console.log('Sending cancel request:', requestBody);
    
    const response = await fetch('/api/schedule/cancel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Booking cancelled successfully!');
      
      // Refresh user credits after cancellation
      const userProfile = await fetchUserCredits();
      if (userProfile && userProfile.user) {
        const user = userProfile.user;
        const totalCredits = parseInt(user.total_credits) || 0;
        const creditsUsed = parseInt(user.credits_used) || 0;
        const creditsRemaining = totalCredits - creditsUsed;
        
        document.getElementById('status-total').textContent = totalCredits;
        document.getElementById('status-used').textContent = creditsUsed;
        document.getElementById('status-remaining').textContent = Math.max(0, creditsRemaining);
      }
      
      fetchSchedule(selectedDate, currentTab === 'history');
    } else {
      alert(result.message || 'Failed to cancel booking');
    }
  } catch (error) {
    console.error('Error cancelling booking:', error);
    alert('Failed to cancel booking. Please try again.');
  }
}

// Confirm booking button handler
document.getElementById('confirm-booking-btn').addEventListener('click', async () => {
  if (!pendingBookingSid) {
    console.error('No pending booking sid');
    alert('Error: No schedule selected');
    return;
  }
  
  // Store sid in local variable BEFORE closing modal (which sets pendingBookingSid to null)
  const sidToBook = pendingBookingSid;
  console.log('Confirming booking for sid:', sidToBook);
  
  closeBookingModal();
  
  try {
    const requestBody = { sid: sidToBook };
    console.log('Sending booking request:', requestBody);
    
    const response = await fetch('/api/schedule/book', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Class booked successfully!');
      
      // Refresh user credits after booking
      const userProfile = await fetchUserCredits();
      if (userProfile && userProfile.user) {
        const user = userProfile.user;
        const totalCredits = parseInt(user.total_credits) || 0;
        const creditsUsed = parseInt(user.credits_used) || 0;
        const creditsRemaining = totalCredits - creditsUsed;
        
        document.getElementById('status-total').textContent = totalCredits;
        document.getElementById('status-used').textContent = creditsUsed;
        document.getElementById('status-remaining').textContent = Math.max(0, creditsRemaining);
      }
      
      fetchSchedule(selectedDate, currentTab === 'history');
    } else {
      alert(result.message || 'Failed to book class');
    }
  } catch (error) {
    console.error('Error booking class:', error);
    alert('Failed to book class. Please try again.');
  }
});

// Cancel booking button handler
document.getElementById('cancel-booking-btn').addEventListener('click', () => {
  closeBookingModal();
});

// Close modal when clicking outside
document.getElementById('booking-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeBookingModal();
  }
});

// Render full month calendar in modal
function renderModalCalendar() {
  const datesContainer = document.getElementById('modal-calendar-dates');
  datesContainer.innerHTML = '';
  
  const year = modalCurrentMonth.getFullYear();
  const month = modalCurrentMonth.getMonth();
  
  // Update header
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('modal-month-year').textContent = months[month];
  document.getElementById('modal-year').textContent = year;
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();
  
  // Add previous month's trailing days
  for (let i = firstDay - 1; i >= 0; i--) {
    const dateDiv = document.createElement('div');
    dateDiv.className = 'modal-calendar-date other-month';
    dateDiv.textContent = daysInPrevMonth - i;
    datesContainer.appendChild(dateDiv);
  }
  
  // Add current month's days
  for (let day = 1; day <= daysInMonth; day++) {
    const dateDiv = document.createElement('div');
    dateDiv.className = 'modal-calendar-date';
    dateDiv.textContent = day;
    
    const currentDate = new Date(year, month, day);
    
    // Check if selected
    if (currentDate.toDateString() === selectedDate.toDateString()) {
      dateDiv.classList.add('selected');
    }
    
    dateDiv.onclick = () => {
      selectedDate = currentDate;
      modalCurrentMonth = new Date(year, month, 1);
      
      // Update mini calendar to show month of selected date
      currentWeekStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
      
      renderCalendar();
      updateCalendarTitle();
      fetchSchedule(selectedDate, currentTab === 'history'); // Fetch new data
      renderModalCalendar();
      closeCalendarModal();
    };
    
    datesContainer.appendChild(dateDiv);
  }
  
  // Add next month's leading days
  const totalCells = firstDay + daysInMonth;
  const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  
  for (let day = 1; day <= remainingCells; day++) {
    const dateDiv = document.createElement('div');
    dateDiv.className = 'modal-calendar-date other-month';
    dateDiv.textContent = day;
    datesContainer.appendChild(dateDiv);
  }
}

// Modal controls
function showCalendarModal() {
  modalCurrentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
  renderModalCalendar();
  document.getElementById('calendar-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeCalendarModal() {
  document.getElementById('calendar-modal').classList.remove('show');
  document.body.style.overflow = 'auto';
}

// Event listeners
document.getElementById('prev-month').addEventListener('click', () => {
  currentWeekStart.setMonth(currentWeekStart.getMonth() - 1);
  renderCalendar();
});

document.getElementById('next-month').addEventListener('click', () => {
  currentWeekStart.setMonth(currentWeekStart.getMonth() + 1);
  renderCalendar();
});

// Show More Date button
document.getElementById('show-more-dates').addEventListener('click', showCalendarModal);

// Modal navigation
document.getElementById('modal-prev-month').addEventListener('click', () => {
  modalCurrentMonth.setMonth(modalCurrentMonth.getMonth() - 1);
  renderModalCalendar();
});

document.getElementById('modal-next-month').addEventListener('click', () => {
  modalCurrentMonth.setMonth(modalCurrentMonth.getMonth() + 1);
  renderModalCalendar();
});

document.getElementById('close-calendar-modal').addEventListener('click', closeCalendarModal);

// Close modal when clicking outside
document.getElementById('calendar-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCalendarModal();
  }
});

// Tab buttons
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    currentTab = this.dataset.tab;
    
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.classList.remove('active');
      b.style.background = '#9d8c7a';
      b.style.color = 'white';
    });
    this.classList.add('active');
    this.style.background = '#d4c5b0';
    this.style.color = '#4a3829';
    
    // Fetch data based on tab
    fetchSchedule(selectedDate, currentTab === 'history');
  });
});

// Initialize - fetch data on page load
async function initializePage() {
  renderCalendar();
  updateCalendarTitle();
  
  // Fetch user credits information
  const userProfile = await fetchUserCredits();
  if (userProfile && userProfile.user) {
    const user = userProfile.user;
    console.log('Updating status card with user data:', user);
    
    // Update credit display
    const totalCredits = parseInt(user.total_credits) || 0;
    const creditsUsed = parseInt(user.credits_used) || 0;
    const creditsRemaining = totalCredits - creditsUsed;
    
    document.getElementById('status-total').textContent = totalCredits;
    document.getElementById('status-used').textContent = creditsUsed;
    document.getElementById('status-remaining').textContent = Math.max(0, creditsRemaining);
  }
  
  fetchSchedule(selectedDate, false); // Load upcoming classes for today
}

// Call initialization
initializePage();

</script>
